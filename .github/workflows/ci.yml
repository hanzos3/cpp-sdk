name: Hanzo S3 C++ CMake

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# This ensures that previous jobs for the PR are canceled when the PR is
# updated.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        config:
        - {
            name: "Ubuntu_Latest_GCC",
            os: ubuntu-latest,
            build_type: "Release",
            cc: "gcc",
            cxx: "g++"
          }
        - {
            name: "macOS Latest Clang",
            os: macos-latest,
            build_type: "Release",
            cc: "clang",
            cxx: "clang++"
          }
        - {
            name: "Windows Latest MSVC",
            os: windows-latest,
            build_type: "Release",
            cc: "cl",
            cxx: "cl"
          }

    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}

    steps:
    - name: Checkout cpp-sdk
      uses: actions/checkout@v4
      with:
        path: "cpp-sdk"

    - name: Checkout vcpkg
      uses: actions/checkout@v4
      with:
        repository: microsoft/vcpkg
        path: "vcpkg"

    - name: Print env
      run: |
        echo github.event.action: ${{ github.event.action }}
        echo github.event_name: ${{ github.event_name }}

    - name: Install dependencies if Ubuntu
      if: startsWith(matrix.config.name, 'Ubuntu_Latest_GCC')
      run: |
        wget --quiet -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        echo 'deb http://apt.llvm.org/focal/ llvm-toolchain-focal-18 main' | sudo tee -a /etc/apt/sources.list
        sudo apt-get -qy update
        sudo apt-get -qy install cmake
        # NOTE: Downloads upstream server binary for testing. URL and binary names cannot be changed.
        wget --quiet https://dl.min.io/server/minio/release/linux-amd64/minio
        chmod +x minio
        cmake --version
        ./minio --version

    - name: Install dependencies if macOS
      if: startsWith(matrix.config.os, 'macos')
      run: |
        # NOTE: Installs upstream server binary via Homebrew for testing.
        brew install pkg-config cmake minio/stable/minio
        cmake --version
        minio --version

    - name: Install dependencies if Windows
      shell: bash
      if: startsWith(matrix.config.os, 'windows')
      run: |
        choco install -y --no-progress cmake wget
        # NOTE: Downloads upstream server binary for testing. URL cannot be changed.
        wget --quiet https://dl.min.io/server/minio/release/windows-amd64/minio.exe
        chmod +x minio.exe
        cmake --version

    - name: Configure and Build
      shell: bash
      run: |
        ./vcpkg/bootstrap-vcpkg.sh
        cd cpp-sdk
        ../vcpkg/vcpkg install
        cmake . -B ./build -DCMAKE_BUILD_TYPE=${{matrix.config.build_type}} -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake -DS3_CPP_TEST:BOOL=ON
        cmake --build ./build --config ${{matrix.config.build_type}} -j 4

    - name: Start Hanzo S3 server if Ubuntu
      if: startsWith(matrix.config.name, 'Ubuntu_Latest_GCC')
      run: |
        mkdir -p ~/.minio/certs
        cp ./cpp-sdk/tests/public.crt ./cpp-sdk/tests/private.key ~/.minio/certs/
        sudo cp ./cpp-sdk/tests/public.crt /usr/local/share/ca-certificates/
        sudo update-ca-certificates
        # S3_CI_CD env var for Hanzo S3 server CI mode.
        S3_CI_CD=true ./minio server /tmp/test-xl/{1...4}/ &
        sleep 10

    - name: Start Hanzo S3 server if macOS
      if: startsWith(matrix.config.name, 'macos')
      run: |
        # S3_CI_CD env var for Hanzo S3 server CI mode.
        S3_CI_CD=true minio server test-xl/{1...4}/ &
        sleep 10

    - name: Start Hanzo S3 server if Windows
      if: startsWith(matrix.config.os, 'windows')
      shell: bash
      run: |
        mkdir -p ~/.minio/certs
        cp ./cpp-sdk/tests/public.crt ./cpp-sdk/tests/private.key ~/.minio/certs/
        certutil -addstore -f "ROOT" ./cpp-sdk/tests/public.crt
        # S3_CI_CD env var for Hanzo S3 server CI mode.
        S3_CI_CD=true ./minio.exe server test-xl/{1...4}/ &
        sleep 10

    - name: Run tests if Ubuntu
      if: startsWith(matrix.config.name, 'Ubuntu_Latest_GCC')
      run: |
        SERVER_ENDPOINT=localhost:9000 ACCESS_KEY=minioadmin SECRET_KEY=minioadmin ENABLE_HTTPS=1 ./cpp-sdk/build/tests

    - name: Run tests if macOS
      if: startsWith(matrix.config.name, 'macos')
      run: |
        SERVER_ENDPOINT=localhost:9000 ACCESS_KEY=minioadmin SECRET_KEY=minioadmin ./cpp-sdk/build/tests

    - name: Run tests if Windows
      shell: bash
      if: startsWith(matrix.config.os, 'windows')
      run: |
        SERVER_ENDPOINT=localhost:9000 ACCESS_KEY=minioadmin SECRET_KEY=minioadmin ENABLE_HTTPS=1 ./cpp-sdk/build/Release/tests.exe

    - name: Run CMake test
      run: |
        cd cpp-sdk/build
        ctest -C ${{ matrix.config.build_type }}
